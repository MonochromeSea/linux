name: Build Binder Driver (v6.12)
on: [workflow_dispatch]
jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Install full dependencies (for kernel + module build)
        run: |
          sudo apt update -y
          sudo apt install -y \
            build-essential gcc make libncurses5-dev \
            flex bison openssl libssl-dev libelf-dev \
            bc git libzstd-dev dwarves pkg-config \
            llvm clang lld

      - name: Clone Linux kernel v6.12 source
        run: |
          git clone --depth 1 --branch v6.12 https://github.com/torvalds/linux.git
          cd linux
          if [ ! -f "drivers/android/binder.c" ]; then
            echo "Fatal error: binder.c not found in kernel source!"
            exit 1
          fi

      - name: Prepare kernel module build environment (fixed)
        run: |
          cd linux
          make defconfig
          # 关键修复：编译 vmlinux 强制生成 Module.symvers
          make vmlinux -j$(nproc) V=1
          make modules_prepare V=1
          if [ ! -f "Module.symvers" ]; then
            echo "Error: Module.symvers not generated (environment preparation failed)!"
            exit 1
          fi
          ls -lh Module.symvers  # 调试用：确认文件存在

      - name: Build Binder driver
        run: |
          cd linux
          make drivers/android/binder.ko \
            V=1 \
            -j$(nproc) \
            EXTRA_CFLAGS="-DCONFIG_ANDROID_BINDER_DEVICES=\"binder,hwbinder,vndbinder\"" \
            EXTRA_CPPFLAGS="-DCONFIG_ANDROID_BINDER_IPC=1 -DCONFIG_ANDROID_BINDERFS=1"

      - name: Verify build success
        run: |
          cd linux
          if [ -f "drivers/android/binder.ko" ]; then
            echo "Binder driver compiled successfully!"
            ls -lh drivers/android/binder.ko
            modinfo drivers/android/binder.ko
          else
            echo "Build failed: binder.ko not found!"
            exit 1
          fi

      - name: Upload compiled Binder module
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: binder-module-v6.12-x86_64
          path: linux/drivers/android/binder.ko
          retention-days: 30
