name: Compile Binder Module

on:
  push:
    paths:
      - 'drivers/android/**'
      - '.github/workflows/compile-binder.yml'
  pull_request:
    paths:
      - 'drivers/android/**'
  workflow_dispatch:

jobs:
  compile:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        kernel_version: ['6.12']

    steps:
      - name: Checkout kernel source
        uses: actions/checkout@v4
        with:
          ref: v${{ matrix.kernel_version }}
          fetch-depth: 1

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libncurses5-dev \
            libssl-dev flex bison libelf-dev dwarves zstd

      - name: Prepare kernel configuration
        run: |
          make defconfig
          scripts/config --enable CONFIG_ANDROID
          scripts/config --enable CONFIG_ANDROID_BINDER_IPC
          scripts/config --enable CONFIG_ANDROID_BINDERFS
          scripts/config --enable CONFIG_ANDROID_BINDER_IPC_SELFTEST

      - name: Build kernel preparation
        run: |
          # 先编译内核基础部分，生成必要的工具和文件
          make prepare
          make scripts

      - name: Build binder modules
        run: |
          # 编译 binder 相关模块
          make M=drivers/android -j$(nproc)

      - name: Verify build output
        run: |
          ls -l drivers/android/*.ko
          for ko in drivers/android/*.ko; do
            modinfo $ko
          done

      - name: Upload binder modules
        uses: actions/upload-artifact@v4
        with:
          name: binder-modules-${{ matrix.kernel_version }}
          path: |
            drivers/android/*.ko
          retention-days: 7
